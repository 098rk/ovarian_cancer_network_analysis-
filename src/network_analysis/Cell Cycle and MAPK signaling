import networkx as nx
import matplotlib.pyplot as plt
import numpy as np

# Define the unorganized Cell Cycle network edges
cell_cycle_edges = [
    ('Cyclin D', 'CDK4/6'),
    ('Cyclin E', 'CDK2'),
    ('Cyclin A', 'CDK2'),
    ('Cyclin B', 'CDK1'),
    ('Cyclin D/CDK4/6', 'Rb'),
    ('Rb', 'E2F'),
    ('Phosphorylated Rb', 'E2F'),
    ('E2F', 'DNA replication genes'),
    ('DNA damage', 'ATM/ATR'),
    ('ATM/ATR', 'CHK1/CHK2'),
    ('CHK1/CHK2', 'CDK1'),
    ('CHK1/CHK2', 'CDK2'),
    ('ATM/ATR', 'p53'),
    ('p53', 'p21'),
    ('p21', 'CDK4/6'),
    ('p21', 'CDK2'),
    ('Spindle checkpoint components', 'Anaphase progression'),
    ('Mitotic Exit Network', 'Exit from Mitosis'),
    ('Growth factors', 'Cyclin D')
]

# Define the unorganized MAPK network edges
mapk_edges = [
    ('EGFR', 'RAS'),
    ('RAS', 'MEK'),
    ('MEK', 'ERK'),
    ('ERK', 'RSK'),
    ('RSK', 'MYC'),
    ('EGFR', 'PI3K'),
    ('PI3K', 'AKT'),
    ('AKT', 'mTOR'),
    ('mTOR', 'p70S6K'),
    ('ERK', 'CREB'),
    ('ERK', 'ELK1'),
    ('ERK', 'RSK'),
    ('JNK', 'c-Jun'),
    ('p38', 'ATF2'),
    ('Ras', 'NF-kB')
]

# Create unorganized networks as DIRECTED GRAPHS
G_cell_cycle_unorganized = nx.DiGraph()
G_mapk_unorganized = nx.DiGraph()

# Add edges to the unorganized networks
G_cell_cycle_unorganized.add_edges_from(cell_cycle_edges)
G_mapk_unorganized.add_edges_from(mapk_edges)

# Plot Cell Cycle Pathway separately (With Edges)
plt.figure(figsize=(10, 8))
pos_cell_cycle = nx.spring_layout(G_cell_cycle_unorganized, seed=42, k=1.5)
nx.draw(G_cell_cycle_unorganized, pos=pos_cell_cycle, with_labels=True, node_color='lightblue', edge_color='gray', node_size=2500, font_size=12, font_weight='bold', arrows=True)
plt.title("Unorganized Cell Cycle Pathway (With Edges)", fontsize=14)
plt.show()

# Plot MAPK Signaling Pathway separately (With Edges)
plt.figure(figsize=(10, 8))
pos_mapk = nx.spring_layout(G_mapk_unorganized, seed=42, k=1.5)
nx.draw(G_mapk_unorganized, pos=pos_mapk, with_labels=True, node_color='lightgreen', edge_color='gray', node_size=2500, font_size=12, font_weight='bold', arrows=True)
plt.title("Unorganized MAPK Signaling Pathway (With Edges)", fontsize=14)
plt.show()

# Define the unorganized Cell Cycle network nodes
cell_cycle_nodes = [
    'Cyclin D', 'CDK4/6', 'Cyclin E', 'CDK2', 'Cyclin A', 'Cyclin B', 'CDK1',
    'Rb', 'E2F', 'Phosphorylated Rb', 'DNA replication genes', 'DNA damage',
    'ATM/ATR', 'CHK1/CHK2', 'p53', 'p21', 'Spindle checkpoint components',
    'Anaphase progression', 'Mitotic Exit Network', 'Exit from Mitosis', 'Growth factors'
]

# Define the unorganized MAPK network nodes
mapk_nodes = [
    'EGFR', 'RAS', 'MEK', 'ERK', 'RSK', 'MYC', 'PI3K', 'AKT', 'mTOR',
    'p70S6K', 'CREB', 'ELK1', 'JNK', 'c-Jun', 'p38', 'ATF2', 'NF-kB'
]

# Create unorganized networks with only nodes (as DiGraph for consistency)
G_cell_cycle_nodes_only = nx.DiGraph()
G_mapk_nodes_only = nx.DiGraph()

# Add nodes to the unorganized networks
G_cell_cycle_nodes_only.add_nodes_from(cell_cycle_nodes)
G_mapk_nodes_only.add_nodes_from(mapk_nodes)

# Plot Cell Cycle Pathway separately (Nodes Only)
plt.figure(figsize=(8, 6))
pos_cell_cycle = nx.spring_layout(G_cell_cycle_nodes_only, seed=42)
nx.draw(G_cell_cycle_nodes_only, pos=pos_cell_cycle, with_labels=True, node_color='lightblue', node_size=2000, font_size=10, arrows=False)
plt.title("Unorganized Cell Cycle Pathway (Nodes Only)")
plt.show()

# Plot MAPK Signaling Pathway separately (Nodes Only)
plt.figure(figsize=(8, 6))
pos_mapk = nx.spring_layout(G_mapk_nodes_only, seed=42)
nx.draw(G_mapk_nodes_only, pos=pos_mapk, with_labels=True, node_color='lightgreen', node_size=2000, font_size=10, arrows=False)
plt.title("Unorganized MAPK Signaling Pathway (Nodes Only)")
plt.show()

# Random Walk Simulation
def random_walk(G, start_node, num_steps):
    current_node = start_node
    visiting_counts = {node: 0 for node in G.nodes()}

    for _ in range(num_steps):
        visiting_counts[current_node] += 1
        # For directed graphs, use successors (outgoing edges)
        neighbors = list(G.successors(current_node))
        if not neighbors:
            break
        current_node = np.random.choice(neighbors)

    return visiting_counts

# Boolean Model Simulation
def boolean_model_simulation(G, timesteps=100):
    activation_counts = {node: 0 for node in G.nodes()}
    for _ in range(timesteps):
        for node in G.nodes():
            if np.random.rand() > 0.5:  # Random activation
                activation_counts[node] += 1
    return activation_counts

# Perform Random Walks
num_walks = 1000
num_steps = 50
start_node_cell_cycle = 'Cyclin D'
start_node_mapk = 'EGFR'

total_visiting_counts_cell_cycle = {node: 0 for node in G_cell_cycle_unorganized.nodes()}
total_visiting_counts_mapk = {node: 0 for node in G_mapk_unorganized.nodes()}

for _ in range(num_walks):
    counts_cell_cycle = random_walk(G_cell_cycle_unorganized, start_node_cell_cycle, num_steps)
    counts_mapk = random_walk(G_mapk_unorganized, start_node_mapk, num_steps)

    for node in total_visiting_counts_cell_cycle:
        total_visiting_counts_cell_cycle[node] += counts_cell_cycle[node]

    for node in total_visiting_counts_mapk:
        total_visiting_counts_mapk[node] += counts_mapk[node]

# Normalize visit counts
for node in total_visiting_counts_cell_cycle:
    total_visiting_counts_cell_cycle[node] /= num_walks

for node in total_visiting_counts_mapk:
    total_visiting_counts_mapk[node] /= num_walks

# Boolean Model Simulation
cell_cycle_boolean = boolean_model_simulation(G_cell_cycle_unorganized)
mapk_boolean = boolean_model_simulation(G_mapk_unorganized)

# PageRank Analysis
cell_cycle_pagerank = nx.pagerank(G_cell_cycle_unorganized)
mapk_pagerank = nx.pagerank(G_mapk_unorganized)

# Centrality Measures
cell_cycle_betweenness = nx.betweenness_centrality(G_cell_cycle_unorganized)
mapk_betweenness = nx.betweenness_centrality(G_mapk_unorganized)

# Motif Analysis - Now using directed graphs
try:
    cell_cycle_motifs = nx.triadic_census(G_cell_cycle_unorganized)
    mapk_motifs = nx.triadic_census(G_mapk_unorganized)
except Exception as e:
    print(f"Motif analysis error: {e}")
    # Alternative: Use a simple triangle count for undirected version
    G_cell_cycle_undirected = G_cell_cycle_unorganized.to_undirected()
    G_mapk_undirected = G_mapk_unorganized.to_undirected()
    
    cell_cycle_triangles = nx.triangles(G_cell_cycle_undirected)
    mapk_triangles = nx.triangles(G_mapk_undirected)
    
    cell_cycle_motifs = f"Triangle counts: {sum(cell_cycle_triangles.values()) // 3}"
    mapk_motifs = f"Triangle counts: {sum(mapk_triangles.values()) // 3}"

# Print Results
print("Cell Cycle Pathway - Random Walk Visit Counts:")
for node, count in sorted(total_visiting_counts_cell_cycle.items(), key=lambda x: x[1], reverse=True):
    print(f"  {node}: {count:.4f}")

print("\nMAPK Pathway - Random Walk Visit Counts:")
for node, count in sorted(total_visiting_counts_mapk.items(), key=lambda x: x[1], reverse=True):
    print(f"  {node}: {count:.4f}")

print("\nCell Cycle Pathway - Boolean Model Activation:")
for node, count in sorted(cell_cycle_boolean.items(), key=lambda x: x[1], reverse=True):
    print(f"  {node}: {count}")

print("\nMAPK Pathway - Boolean Model Activation:")
for node, count in sorted(mapk_boolean.items(), key=lambda x: x[1], reverse=True):
    print(f"  {node}: {count}")

print("\nCell Cycle Pathway - PageRank Scores:")
for node, score in sorted(cell_cycle_pagerank.items(), key=lambda x: x[1], reverse=True):
    print(f"  {node}: {score:.4f}")

print("\nMAPK Pathway - PageRank Scores:")
for node, score in sorted(mapk_pagerank.items(), key=lambda x: x[1], reverse=True):
    print(f"  {node}: {score:.4f}")

print("\nCell Cycle Pathway - Betweenness Centrality:")
for node, centrality in sorted(cell_cycle_betweenness.items(), key=lambda x: x[1], reverse=True):
    print(f"  {node}: {centrality:.4f}")

print("\nMAPK Pathway - Betweenness Centrality:")
for node, centrality in sorted(mapk_betweenness.items(), key=lambda x: x[1], reverse=True):
    print(f"  {node}: {centrality:.4f}")

print("\nCell Cycle Pathway - Triadic Motifs:")
print(cell_cycle_motifs)

print("\nMAPK Pathway - Triadic Motifs:")
print(mapk_motifs)

# Additional network statistics
print("\n=== Network Statistics ===")
print(f"Cell Cycle Network:")
print(f"  Nodes: {G_cell_cycle_unorganized.number_of_nodes()}")
print(f"  Edges: {G_cell_cycle_unorganized.number_of_edges()}")
print(f"  Density: {nx.density(G_cell_cycle_unorganized):.4f}")

print(f"\nMAPK Network:")
print(f"  Nodes: {G_mapk_unorganized.number_of_nodes()}")
print(f"  Edges: {G_mapk_unorganized.number_of_edges()}")
print(f"  Density: {nx.density(G_mapk_unorganized):.4f}")
